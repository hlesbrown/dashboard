<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Les Brown â€” Project Dashboard</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1B2845">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dashboard">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --navy-deep: #1B2845;
      --navy-mid: #2D3F5E;
      --gold: #C9A961;
      --cream: #F5F1E8;
      --text-secondary: #A0AEC0;
      --text-muted: #6B7280;
      --border-subtle: rgba(255,255,255,0.08);
      --border-gold: rgba(201,169,97,0.2);
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      background: linear-gradient(135deg, var(--navy-deep) 0%, var(--navy-mid) 50%, var(--navy-deep) 100%);
      color: var(--cream);
      min-height: 100vh;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
    }

    .ui { font-family: system-ui, -apple-system, sans-serif; }

    /* â”€â”€ Header â”€â”€ */
    .header { max-width: 800px; margin: 0 auto 24px; text-align: center; }
    .header h1 { font-size: 28px; font-weight: 400; letter-spacing: 0.08em; color: var(--gold); margin-bottom: 4px; }
    .header-line { width: 60px; height: 2px; background: var(--gold); margin: 8px auto; }
    .header-date { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }

    .badges { display: flex; gap: 10px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .badge { display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 13px; }
    .badge-urgent { background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); color: #FCA5A5; }
    .badge-upcoming { background: rgba(217,119,6,0.15); border: 1px solid rgba(217,119,6,0.3); color: #FBBF24; }
    .badge-done { background: rgba(5,150,105,0.15); border: 1px solid rgba(5,150,105,0.3); color: #6EE7B7; }

    .error-banner { margin-top: 10px; padding: 8px 16px; border-radius: 8px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); color: #FCA5A5; font-size: 13px; }

    /* â”€â”€ Calendar â”€â”€ */
    .calendar { max-width: 800px; margin: 0 auto 28px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-gold); overflow: hidden; }
    .calendar-header { padding: 14px 18px 10px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
    .calendar-header h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--gold); font-weight: 600; }
    .calendar-header span { font-size: 12px; color: var(--text-muted); }
    
    .day-tabs { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border-subtle); }
    .day-tab { padding: 10px 4px 8px; border: none; border-bottom: 2px solid transparent; background: transparent; cursor: pointer; text-align: center; transition: all 0.2s; }
    .day-tab.selected { border-bottom-color: var(--gold); background: rgba(201,169,97,0.1); }
    .day-tab-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 600; margin-bottom: 2px; }
    .day-tab.selected .day-tab-label { color: var(--gold); }
    .day-tab-num { font-size: 16px; font-weight: 400; color: var(--text-secondary); width: 28px; height: 28px; line-height: 28px; margin: 0 auto; border-radius: 50%; }
    .day-tab.selected .day-tab-num { color: var(--gold); }
    .day-tab.today .day-tab-num { font-weight: 700; color: var(--cream); background: rgba(201,169,97,0.3); }
    .day-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text-muted); margin: 4px auto 0; }
    .day-tab.selected .day-dot { background: var(--gold); }

    .day-events { padding: 14px 18px 16px; min-height: 80px; }
    .day-title { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .day-title h3 { font-size: 15px; color: var(--cream); font-weight: 600; }
    .today-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: rgba(201,169,97,0.2); color: var(--gold); text-transform: uppercase; letter-spacing: 0.05em; }
    .no-events { font-size: 13px; color: var(--text-muted); font-style: italic; }

    .event-row { display: flex; align-items: flex-start; gap: 10px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); margin-bottom: 8px; }
    .event-time { min-width: 72px; font-size: 12px; color: var(--text-secondary); font-weight: 600; padding-top: 1px; flex-shrink: 0; }
    .event-bar { width: 3px; min-height: 20px; align-self: stretch; border-radius: 2px; flex-shrink: 0; }
    .event-body { flex: 1; }
    .event-name { font-size: 13px; color: var(--cream); font-weight: 500; }
    .event-tag { font-size: 10px; padding: 1px 6px; border-radius: 8px; display: inline-block; margin-left: 6px; }
    .event-tag-location { background: rgba(148,163,184,0.15); color: #94A3B8; }
    .event-tag-auto { background: rgba(5,150,105,0.15); color: #059669; }
    .event-detail { font-size: 12px; color: var(--text-muted); margin-top: 4px; line-height: 1.5; }
    .event-duration { font-size: 10px; color: var(--text-muted); }

    /* â”€â”€ Filters â”€â”€ */
    .filters { max-width: 800px; margin: 0 auto 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: var(--text-secondary); cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .filter-btn.active { border-color: var(--gold); background: rgba(201,169,97,0.2); color: var(--gold); }

    /* â”€â”€ Groups & Tasks â”€â”€ */
    .groups { max-width: 800px; margin: 0 auto; }
    .group { margin-bottom: 24px; }
    .group-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 0 4px; }
    .group-header span.icon { font-size: 18px; }
    .group-header h3 { font-size: 16px; font-weight: 600; margin: 0; letter-spacing: 0.02em; }
    .group-header .count { font-size: 11px; color: var(--text-muted); }

    .task-card { margin-bottom: 10px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle); transition: all 0.25s; overflow: hidden; }
    .task-card.expanded { background: rgba(255,255,255,0.08); }
    .task-card.urgent-border { border-color: rgba(220,38,38,0.4); }
    .task-card.upcoming-border { border-color: rgba(217,119,6,0.4); }

    .task-header { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .task-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .task-info { flex: 1; min-width: 0; }
    .task-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .task-title-row h4 { font-size: 14px; font-weight: 600; color: var(--cream); margin: 0; }
    .task-status { font-size: 12px; color: var(--text-secondary); margin-top: 3px; }

    .urgency-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; white-space: nowrap; flex-shrink: 0; }
    .done-tag { font-size: 10px; padding: 2px 7px; border-radius: 10px; background: rgba(5,150,105,0.15); color: #059669; }
    .deadline-tag { font-size: 10px; padding: 2px 7px; border-radius: 10px; }
    .deadline-urgent { background: rgba(220,38,38,0.15); color: #DC2626; }
    .deadline-warn { background: rgba(217,119,6,0.15); color: #D97706; }

    .chevron { color: var(--gold); font-size: 16px; transition: transform 0.25s; flex-shrink: 0; }
    .chevron.open { transform: rotate(180deg); }

    .task-body { padding: 0 16px 14px; border-top: 1px solid var(--border-subtle); }
    .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin: 12px 0 8px; }

    .action-item { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 5px; font-size: 13px; color: #D1D5DB; line-height: 1.4; cursor: pointer; padding: 3px 6px; border-radius: 6px; transition: all 0.2s; }
    .action-item.done { color: var(--text-muted); text-decoration: line-through; opacity: 0.6; }
    .action-check { flex-shrink: 0; margin-top: 1px; width: 16px; height: 16px; border-radius: 4px; border: 1px solid rgba(201,169,97,0.4); background: transparent; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #059669; transition: all 0.2s; }
    .action-check.checked { border-color: #059669; background: rgba(5,150,105,0.2); }

    .links-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .link-btn { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; background: rgba(14,165,233,0.1); border: 1px solid rgba(14,165,233,0.25); color: #7DD3FC; font-size: 12px; text-decoration: none; transition: all 0.2s; }
    .link-btn:hover { background: rgba(14,165,233,0.2); }

    .notes-box { margin-top: 12px; padding: 10px 14px; border-radius: 6px; background: rgba(201,169,97,0.08); border: 1px solid rgba(201,169,97,0.15); }
    .notes-box p { font-size: 13px; color: #D1D5DB; line-height: 1.5; }
    .last-touched { font-size: 11px; color: var(--text-muted); margin-top: 10px; }

    /* â”€â”€ Footer â”€â”€ */
    .footer { max-width: 800px; margin: 24px auto 0; text-align: center; padding: 16px 0; border-top: 1px solid var(--border-subtle); }
    .footer p { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
    .footer-actions { display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .footer-actions span { font-size: 11px; color: #4B5563; }
    .footer-btn { font-size: 11px; background: none; border: 1px solid rgba(201,169,97,0.3); border-radius: 4px; padding: 3px 10px; cursor: pointer; color: var(--gold); }
    .footer-btn.muted { border-color: rgba(255,255,255,0.1); color: var(--text-muted); }

    /* â”€â”€ Loading â”€â”€ */
    .loading { min-height: 100vh; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 18px; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(201,169,97,0.3); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 600px) {
      body { padding: 12px; }
      .header h1 { font-size: 20px; letter-spacing: 0.04em; }
      .day-tab-label { font-size: 9px; }
      .day-tab-num { font-size: 14px; width: 24px; height: 24px; line-height: 24px; }
      .event-time { min-width: 56px; font-size: 11px; }
    }
  </style>
</head>
<body>

<div id="app">
  <div class="loading"><div class="spinner"></div> Loading dashboardâ€¦</div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = "https://dashboardapi-production.up.railway.app";
const API_KEY = "hlbdashboard";
const STORAGE_KEY = "les-dashboard-completed-v3";

// â”€â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCHEDULE = {
  Sunday: [
    { time: "4:00 AM", event: "Liturgy prep", category: "Ministry", duration: 120 },
    { time: "6:00 AM", event: "Liturgy (Zoom)", category: "Ministry", duration: 60 },
    { time: "8:00 AM", event: "Post-liturgy work block", category: "Ministry", detail: "Video editing, post homily (website, Medium & gbchapel.com), post liturgy videos, prep Thursday email (Mailchimp), update liturgical calendar, set up green screen for podcast, start podcast video edit" },
  ],
  Monday: [
    { time: "AM", event: "Publish podcast to Substack, YouTube", category: "Content", detail: "Publish as 'Podcast Episode' not 'Post' in Substack" },
    { time: "AM", event: "Distribute podcast to social media", category: "Content", detail: "Meta Business Suite/Facebook, Instagram, Bluesky, LinkedIn. Apple/Spotify via Substack RSS." },
    { time: "12:00 PM", event: "AA Meeting", category: "Personal", duration: 60, location: "Out" },
  ],
  Tuesday: [
    { time: "AM", event: "Review & update social media posting approach", category: "Content", detail: "Instagram and LinkedIn connections need attention" },
    { time: "AM", event: "Prep for AA lead (Wednesday)", category: "Personal" },
    { time: "12:00 PM", event: "Lunch â€” Frank D. or Dennis", category: "Personal", duration: 60, location: "Out" },
  ],
  Wednesday: [
    { time: "11:30 AM", event: "Zoom host â€” AA Meeting (YOUR LEAD)", category: "Personal", duration: 90, detail: "You're leading this week â€” make sure prep is done" },
    { time: "3:00 PM", event: "Meet with Frank P.", category: "Personal", duration: 60 },
  ],
  Thursday: [
    { time: "6:30 AM", event: "Liturgy email sent (automated)", category: "Ministry", automated: true },
  ],
  Friday: [
    { time: "10:00 AM", event: "Zoom with Frank D.", category: "Personal", duration: 30 },
    { time: "10:30 AM", event: "Zoom host â€” AA Meeting", category: "Personal", duration: 90 },
    { time: "PM", event: "Start on homily", category: "Ministry" },
  ],
  Saturday: [
    { time: "AM", event: "Finish homily & upload to teleprompter", category: "Ministry" },
    { time: "AM", event: "Podcast script due", category: "Content", detail: "Episode script must be finished by end of Saturday" },
    { time: "PM", event: "Set up video equipment for Sunday Zoom", category: "Ministry" },
  ],
};

const DAY_ORDER = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const CAT_COLORS = { Writing: "#8B5CF6", Tech: "#0EA5E9", Ministry: "#C9A961", Content: "#EC4899", Personal: "#94A3B8" };
const URGENCY = {
  urgent:    { label: "ğŸ”´ URGENT",    color: "#DC2626", order: 0 },
  upcoming:  { label: "ğŸŸ¡ UPCOMING",  color: "#D97706", order: 1 },
  recurring: { label: "ğŸ”µ RECURRING", color: "#2563EB", order: 2 },
  active:    { label: "ğŸŸ¢ ACTIVE",    color: "#059669", order: 3 },
  low:       { label: "âšª LOW",       color: "#6B7280", order: 4 },
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let groups = [];
let completed = {};
let expandedId = null;
let selectedDay = DAY_ORDER[new Date().getDay()];
let activeFilter = "all";
let lastFetched = null;
let error = null;

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function daysUntilDeadline(task) {
  if (task.deadline) {
    const now = new Date(); now.setHours(0,0,0,0);
    const dl = new Date(task.deadline + "T00:00:00");
    return Math.ceil((dl - now) / 86400000);
  }
  if (task.recurring_deadline_day != null) {
    let d = task.recurring_deadline_day - new Date().getDay();
    if (d < 0) d += 7;
    return d;
  }
  return null;
}

function effectiveUrgency(task) {
  if (task.urgency === "urgent") return "urgent";
  const d = daysUntilDeadline(task);
  if (d !== null && d < 0) return "urgent";
  if (d !== null && d <= 2) return "upcoming";
  return task.urgency;
}

function loadCompleted() {
  try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : {}; } catch { return {}; }
}

function saveCompleted() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(completed)); } catch {}
}

async function fetchDashboard() {
  const res = await fetch(`${API_BASE}/dashboard`, { headers: { "X-API-Key": API_KEY } });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const app = document.getElementById("app");
  const now = new Date();
  const todayName = DAY_ORDER[now.getDay()];
  const sunday = new Date(now); sunday.setDate(now.getDate() - now.getDay());
  const weekDates = DAY_ORDER.map((_, i) => { const d = new Date(sunday); d.setDate(sunday.getDate() + i); return d; });
  const todayStr = now.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" });

  const allTasks = groups.flatMap(g => g.tasks);
  const urgentCount = allTasks.filter(t => effectiveUrgency(t) === "urgent").length;
  const upcomingCount = allTasks.filter(t => effectiveUrgency(t) === "upcoming").length;
  const totalDone = Object.values(completed).reduce((s, p) => s + Object.values(p).filter(Boolean).length, 0);

  // Filter groups
  let filtered = groups;
  if (activeFilter === "urgent") {
    filtered = groups.map(g => ({ ...g, tasks: g.tasks.filter(t => { const e = effectiveUrgency(t); return e === "urgent" || e === "upcoming"; }) })).filter(g => g.tasks.length > 0);
  } else if (activeFilter !== "all") {
    filtered = groups.filter(g => g.id === activeFilter);
  }

  const selectedEvents = SCHEDULE[selectedDay] || [];

  app.innerHTML = `
    <!-- Header -->
    <div class="header">
      <h1>LES BROWN â€” PROJECT DASHBOARD</h1>
      <div class="header-line"></div>
      <p class="header-date ui">${todayStr}</p>
      ${error ? `<div class="error-banner ui">âš  ${error}</div>` : ""}
      <div class="badges ui">
        ${urgentCount > 0 ? `<div class="badge badge-urgent">${urgentCount} urgent</div>` : ""}
        ${upcomingCount > 0 ? `<div class="badge badge-upcoming">${upcomingCount} upcoming</div>` : ""}
        ${totalDone > 0 ? `<div class="badge badge-done">${totalDone} action${totalDone > 1 ? "s" : ""} completed âœ”</div>` : ""}
      </div>
    </div>

    <!-- Calendar -->
    <div class="calendar ui">
      <div class="calendar-header">
        <h2>Weekly Rhythm</h2>
        <span>Week of ${weekDates[0].toLocaleDateString("en-US", { month: "short", day: "numeric" })}</span>
      </div>
      <div class="day-tabs">
        ${DAY_ORDER.map((day, i) => {
          const isToday = day === todayName;
          const isSel = day === selectedDay;
          const has = (SCHEDULE[day] || []).length > 0;
          return `<button class="day-tab${isSel ? " selected" : ""}${isToday ? " today" : ""}" data-day="${day}">
            <div class="day-tab-label">${day.slice(0,3)}</div>
            <div class="day-tab-num">${weekDates[i].getDate()}</div>
            ${has ? '<div class="day-dot"></div>' : ""}
          </button>`;
        }).join("")}
      </div>
      <div class="day-events">
        <div class="day-title">
          <h3>${selectedDay}</h3>
          ${selectedDay === todayName ? '<span class="today-badge">Today</span>' : ""}
        </div>
        ${selectedEvents.length === 0 ? '<p class="no-events">No scheduled items â€” open time for projects</p>' :
          selectedEvents.map(evt => {
            const cc = CAT_COLORS[evt.category] || "#94A3B8";
            return `<div class="event-row">
              <div class="event-time">${evt.time}</div>
              <div class="event-bar" style="background:${cc}"></div>
              <div class="event-body">
                <div>
                  <span class="event-name">${evt.event}</span>
                  ${evt.location ? `<span class="event-tag event-tag-location">ğŸ“ ${evt.location}</span>` : ""}
                  ${evt.automated ? '<span class="event-tag event-tag-auto">âš¡ Auto</span>' : ""}
                </div>
                ${evt.detail ? `<p class="event-detail">${evt.detail}</p>` : ""}
                ${evt.duration ? `<span class="event-duration">${evt.duration >= 60 ? (evt.duration/60)+"h" : evt.duration+"m"}</span>` : ""}
              </div>
            </div>`;
          }).join("")
        }
      </div>
    </div>

    <!-- Filters -->
    <div class="filters ui">
      <button class="filter-btn${activeFilter === "all" ? " active" : ""}" data-filter="all">All Projects</button>
      <button class="filter-btn${activeFilter === "urgent" ? " active" : ""}" data-filter="urgent">ğŸ”´ Needs Attention</button>
      ${groups.map(g => `<button class="filter-btn${activeFilter === g.id ? " active" : ""}" data-filter="${g.id}">${g.icon} ${g.name}</button>`).join("")}
    </div>

    <!-- Groups -->
    <div class="groups">
      ${filtered.map(group => {
        const sorted = [...group.tasks].sort((a,b) => (URGENCY[effectiveUrgency(a)]?.order ?? 99) - (URGENCY[effectiveUrgency(b)]?.order ?? 99));
        return `<div class="group">
          <div class="group-header ui">
            <span class="icon">${group.icon}</span>
            <h3 style="color:${group.color}">${group.name}</h3>
            <span class="count">(${group.tasks.length})</span>
          </div>
          ${sorted.map(task => {
            const eff = effectiveUrgency(task);
            const urg = URGENCY[eff];
            const taskDone = completed[task.id] || {};
            const doneCount = Object.values(taskDone).filter(Boolean).length;
            const dl = daysUntilDeadline(task);
            const isOpen = expandedId === task.id;
            const borderClass = eff === "urgent" ? " urgent-border" : eff === "upcoming" ? " upcoming-border" : "";

            return `<div class="task-card${isOpen ? " expanded" : ""}${borderClass}">
              <div class="task-header" data-task-toggle="${task.id}">
                <div class="task-dot" style="background:${group.color}"></div>
                <div class="task-info ui">
                  <div class="task-title-row">
                    <h4>${task.name}</h4>
                    ${doneCount > 0 ? `<span class="done-tag">${doneCount}/${task.next_actions.length} done</span>` : ""}
                    ${dl !== null && dl >= 0 && dl <= 7 ? `<span class="deadline-tag ${dl <= 1 ? "deadline-urgent" : "deadline-warn"}">${dl === 0 ? "Due today" : dl === 1 ? "Due tomorrow" : dl + " days left"}</span>` : ""}
                  </div>
                  <p class="task-status">${task.status}</p>
                </div>
                <span class="urgency-tag ui" style="background:${urg.color}22;color:${urg.color}">${urg.label}</span>
                <span class="chevron${isOpen ? " open" : ""}">â–¾</span>
              </div>
              ${isOpen ? `<div class="task-body ui">
                <div class="section-label">Next Actions</div>
                ${task.next_actions.map((action, i) => {
                  const isDone = taskDone[i] === true;
                  return `<div class="action-item${isDone ? " done" : ""}" data-action="${task.id}-${i}">
                    <span class="action-check${isDone ? " checked" : ""}">${isDone ? "âœ”" : ""}</span>
                    <span>${action}</span>
                  </div>`;
                }).join("")}
                ${task.links && task.links.length > 0 ? `
                  <div class="section-label">Links & Files</div>
                  <div class="links-row">
                    ${task.links.map(l => `<a class="link-btn" href="${l.url}" target="_blank" rel="noopener">ğŸ”— ${l.label}</a>`).join("")}
                  </div>` : ""}
                ${task.notes ? `<div class="notes-box"><div class="section-label" style="margin-top:0">Notes & Reminders</div><p>${task.notes}</p></div>` : ""}
                <p class="last-touched">Last touched: ${task.last_touched}</p>
              </div>` : ""}
            </div>`;
          }).join("")}
        </div>`;
      }).join("")}
    </div>

    <!-- Footer -->
    <div class="footer ui">
      <p>${allTasks.length} tasks across ${groups.length} groups Â· Data from Railway API Â· ğŸŸ¡ UPCOMING = deadline within 2 days</p>
      <div class="footer-actions">
        ${lastFetched ? `<span>Fetched ${lastFetched.toLocaleTimeString()}</span>` : ""}
        <button class="footer-btn" id="refresh-btn">â†» Refresh</button>
        ${totalDone > 0 ? '<button class="footer-btn muted" id="reset-btn">Reset completed</button>' : ""}
      </div>
    </div>
  `;

  // â”€â”€ Bind Events â”€â”€
  document.querySelectorAll(".day-tab").forEach(btn => {
    btn.addEventListener("click", () => { selectedDay = btn.dataset.day; render(); });
  });

  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => { activeFilter = btn.dataset.filter; render(); });
  });

  document.querySelectorAll("[data-task-toggle]").forEach(el => {
    el.addEventListener("click", () => {
      const id = parseInt(el.dataset.taskToggle);
      expandedId = expandedId === id ? null : id;
      render();
    });
  });

  document.querySelectorAll("[data-action]").forEach(el => {
    el.addEventListener("click", (e) => {
      e.stopPropagation();
      const [taskId, actionIdx] = el.dataset.action.split("-").map(Number);
      if (!completed[taskId]) completed[taskId] = {};
      completed[taskId][actionIdx] = !completed[taskId][actionIdx];
      saveCompleted();
      render();
    });
  });

  const refreshBtn = document.getElementById("refresh-btn");
  if (refreshBtn) refreshBtn.addEventListener("click", loadDashboard);

  const resetBtn = document.getElementById("reset-btn");
  if (resetBtn) resetBtn.addEventListener("click", () => {
    if (confirm("Reset all completed actions? This can't be undone.")) {
      completed = {};
      saveCompleted();
      render();
    }
  });
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    groups = await fetchDashboard();
    lastFetched = new Date();
    error = null;
  } catch (e) {
    error = e.message;
    console.error("API fetch failed:", e);
  }
  render();
}

completed = loadCompleted();
loadDashboard();

// Register service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(() => {});
}
</script>
</body>
</html>
