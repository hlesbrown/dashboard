<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Les Brown ‚Äî Project Dashboard</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1B2845">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dashboard">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --navy-deep: #1B2845;
      --navy-mid: #2D3F5E;
      --gold: #C9A961;
      --cream: #F5F1E8;
      --text-secondary: #A0AEC0;
      --text-muted: #6B7280;
      --border-subtle: rgba(255,255,255,0.08);
      --border-gold: rgba(201,169,97,0.2);
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      background: linear-gradient(135deg, var(--navy-deep) 0%, var(--navy-mid) 50%, var(--navy-deep) 100%);
      color: var(--cream);
      min-height: 100vh;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
    }

    .ui { font-family: system-ui, -apple-system, sans-serif; }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Header √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .header { max-width: 800px; margin: 0 auto 24px; text-align: center; }
    .header h1 { font-size: 28px; font-weight: 400; letter-spacing: 0.08em; color: var(--gold); margin-bottom: 4px; }
    .header-line { width: 60px; height: 2px; background: var(--gold); margin: 8px auto; }
    .header-date { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }

    .badges { display: flex; gap: 10px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .badge { display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 13px; }
    .badge-urgent { background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); color: #FCA5A5; }
    .badge-upcoming { background: rgba(217,119,6,0.15); border: 1px solid rgba(217,119,6,0.3); color: #FBBF24; }
    .badge-done { background: rgba(5,150,105,0.15); border: 1px solid rgba(5,150,105,0.3); color: #6EE7B7; }

    .error-banner { margin-top: 10px; padding: 8px 16px; border-radius: 8px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); color: #FCA5A5; font-size: 13px; }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Calendar √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .calendar { max-width: 800px; margin: 0 auto 28px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-gold); overflow: hidden; }
    .calendar-header { padding: 14px 18px 10px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .calendar-header h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--gold); font-weight: 600; }
    .calendar-header span { font-size: 12px; color: var(--text-muted); }
    .calendar-header .cal-chevron { color: var(--gold); font-size: 16px; transition: transform 0.25s; margin-left: 8px; }
    .calendar-header .cal-chevron.closed { transform: rotate(-90deg); }
    .calendar-header.collapsed { border-bottom: none; }
    
    .day-tabs { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border-subtle); }
    .day-tab { padding: 10px 4px 8px; border: none; border-bottom: 2px solid transparent; background: transparent; cursor: pointer; text-align: center; transition: all 0.2s; }
    .day-tab.selected { border-bottom-color: var(--gold); background: rgba(201,169,97,0.1); }
    .day-tab-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 600; margin-bottom: 2px; }
    .day-tab.selected .day-tab-label { color: var(--gold); }
    .day-tab-num { font-size: 16px; font-weight: 400; color: var(--text-secondary); width: 28px; height: 28px; line-height: 28px; margin: 0 auto; border-radius: 50%; }
    .day-tab.selected .day-tab-num { color: var(--gold); }
    .day-tab.today .day-tab-num { font-weight: 700; color: var(--cream); background: rgba(201,169,97,0.3); }
    .day-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text-muted); margin: 4px auto 0; }
    .day-tab.selected .day-dot { background: var(--gold); }

    .day-events { padding: 14px 18px 16px; min-height: 80px; }
    .day-title { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .day-title h3 { font-size: 15px; color: var(--cream); font-weight: 600; }
    .today-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: rgba(201,169,97,0.2); color: var(--gold); text-transform: uppercase; letter-spacing: 0.05em; }
    .no-events { font-size: 13px; color: var(--text-muted); font-style: italic; }

    .event-row { display: flex; align-items: flex-start; gap: 10px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); margin-bottom: 8px; }
    .event-time { min-width: 72px; font-size: 12px; color: var(--text-secondary); font-weight: 600; padding-top: 1px; flex-shrink: 0; }
    .event-bar { width: 3px; min-height: 20px; align-self: stretch; border-radius: 2px; flex-shrink: 0; }
    .event-body { flex: 1; }
    .event-name { font-size: 13px; color: var(--cream); font-weight: 500; }
    .event-tag { font-size: 10px; padding: 1px 6px; border-radius: 8px; display: inline-block; margin-left: 6px; }
    .event-tag-location { background: rgba(148,163,184,0.15); color: #94A3B8; }
    .event-tag-auto { background: rgba(5,150,105,0.15); color: #059669; }
    .event-detail { font-size: 12px; color: var(--text-muted); margin-top: 4px; line-height: 1.5; }
    .event-duration { font-size: 10px; color: var(--text-muted); }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Filters √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .filters { max-width: 800px; margin: 0 auto 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: var(--text-secondary); cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .filter-btn.active { border-color: var(--gold); background: rgba(201,169,97,0.2); color: var(--gold); }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Groups & Tasks √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .groups { max-width: 800px; margin: 0 auto; }
    .group { margin-bottom: 24px; }
    .group-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 0 4px; }
    .group-header span.icon { font-size: 18px; }
    .group-header h3 { font-size: 16px; font-weight: 600; margin: 0; letter-spacing: 0.02em; }
    .group-header .count { font-size: 11px; color: var(--text-muted); }

    .task-card { margin-bottom: 10px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle); transition: all 0.25s; overflow: hidden; }
    .task-card.expanded { background: rgba(255,255,255,0.08); }
    .task-card.urgent-border { border-color: rgba(220,38,38,0.4); }
    .task-card.upcoming-border { border-color: rgba(217,119,6,0.4); }

    .task-header { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .task-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .task-info { flex: 1; min-width: 0; }
    .task-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .task-title-row h4 { font-size: 14px; font-weight: 600; color: var(--cream); margin: 0; }
    .task-status { font-size: 12px; color: var(--text-secondary); margin-top: 3px; }

    .urgency-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; white-space: nowrap; flex-shrink: 0; }
    .done-tag { font-size: 10px; padding: 2px 7px; border-radius: 10px; background: rgba(5,150,105,0.15); color: #059669; }
    .deadline-tag { font-size: 10px; padding: 2px 7px; border-radius: 10px; }
    .deadline-urgent { background: rgba(220,38,38,0.15); color: #DC2626; }
    .deadline-warn { background: rgba(217,119,6,0.15); color: #D97706; }

    .chevron { color: var(--gold); font-size: 16px; transition: transform 0.25s; flex-shrink: 0; }
    .chevron.open { transform: rotate(180deg); }

    .task-body { padding: 0 16px 14px; border-top: 1px solid var(--border-subtle); }
    .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin: 12px 0 8px; }

    .action-item { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 5px; font-size: 13px; color: #D1D5DB; line-height: 1.4; cursor: pointer; padding: 3px 6px; border-radius: 6px; transition: all 0.2s; }
    .action-item.done { color: var(--text-muted); text-decoration: line-through; opacity: 0.6; }
    .action-check { flex-shrink: 0; margin-top: 1px; width: 16px; height: 16px; border-radius: 4px; border: 1px solid rgba(201,169,97,0.4); background: transparent; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #059669; transition: all 0.2s; }
    .action-check.checked { border-color: #059669; background: rgba(5,150,105,0.2); }

    .links-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .link-btn { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; background: rgba(14,165,233,0.1); border: 1px solid rgba(14,165,233,0.25); color: #7DD3FC; font-size: 12px; text-decoration: none; transition: all 0.2s; }
    .link-btn:hover { background: rgba(14,165,233,0.2); }

    .notes-box { margin-top: 12px; padding: 10px 14px; border-radius: 6px; background: rgba(201,169,97,0.08); border: 1px solid rgba(201,169,97,0.15); }
    .notes-box p { font-size: 13px; color: #D1D5DB; line-height: 1.5; }
    .last-touched { font-size: 11px; color: var(--text-muted); margin-top: 10px; }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Footer √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .footer { max-width: 800px; margin: 24px auto 0; text-align: center; padding: 16px 0; border-top: 1px solid var(--border-subtle); }
    .footer p { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
    .footer-actions { display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .footer-actions span { font-size: 11px; color: #4B5563; }
    .footer-btn { font-size: 11px; background: none; border: 1px solid rgba(201,169,97,0.3); border-radius: 4px; padding: 3px 10px; cursor: pointer; color: var(--gold); }
    .footer-btn.muted { border-color: rgba(255,255,255,0.1); color: var(--text-muted); }

    /* -- Notice Board -- */
    .notice-board { max-width: 800px; margin: 0 auto 24px; }
    .notice-board-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 0 4px; }
    .notice-board-header h3 { font-size: 16px; font-weight: 600; color: var(--gold); }
    .notice-board-header .count { font-size: 11px; color: var(--text-muted); }
    .notice-item { padding: 12px 16px; border-radius: 8px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle); margin-bottom: 8px; }
    .notice-item.priority-important { border-color: rgba(220,38,38,0.3); background: rgba(220,38,38,0.05); }
    .notice-item.priority-normal { border-color: rgba(201,169,97,0.25); }
    .notice-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
    .notice-author { font-size: 11px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .notice-date { font-size: 11px; color: var(--text-muted); }
    .notice-priority-tag { font-size: 10px; padding: 1px 6px; border-radius: 8px; text-transform: uppercase; letter-spacing: 0.03em; }
    .notice-priority-tag.important { background: rgba(220,38,38,0.15); color: #FCA5A5; }
    .notice-priority-tag.normal { background: rgba(201,169,97,0.15); color: var(--gold); }
    .notice-priority-tag.fyi { background: rgba(148,163,184,0.15); color: #94A3B8; }
    .notice-message { font-size: 13px; color: #D1D5DB; line-height: 1.5; }
    .notice-actions { display: flex; gap: 8px; margin-top: 8px; }
    .notice-btn { font-size: 11px; background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 2px 8px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
    .notice-btn:hover { border-color: rgba(201,169,97,0.4); color: var(--gold); }
    .notice-btn.delete:hover { border-color: rgba(220,38,38,0.4); color: #FCA5A5; }
    .notice-edit-area { margin-top: 8px; }
    .notice-edit-area textarea { width: 100%; min-height: 60px; padding: 8px 10px; border-radius: 6px; border: 1px solid rgba(201,169,97,0.3); background: rgba(255,255,255,0.06); color: var(--cream); font-size: 13px; font-family: system-ui, sans-serif; resize: vertical; outline: none; }
    .notice-edit-area textarea:focus { border-color: var(--gold); }
    .notice-edit-actions { display: flex; gap: 6px; margin-top: 6px; }
    .notice-save-btn { font-size: 11px; padding: 3px 10px; border-radius: 4px; border: none; background: var(--gold); color: var(--navy-deep); cursor: pointer; font-weight: 600; }
    .notice-cancel-btn { font-size: 11px; padding: 3px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: none; color: var(--text-muted); cursor: pointer; }

    /* -- Claude Notes -- */
    .claude-notes { max-width: 800px; margin: 24px auto 0; }
    .claude-notes-toggle { width: 100%; display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); cursor: pointer; transition: all 0.2s; }
    .claude-notes-toggle:hover { background: rgba(255,255,255,0.06); }
    .claude-notes-icon { font-size: 16px; }
    .claude-notes-label { font-size: 12px; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase; flex: 1; text-align: left; }
    .claude-notes-chevron { color: var(--text-muted); font-size: 14px; transition: transform 0.25s; }
    .claude-notes-chevron.open { transform: rotate(180deg); }
    .claude-notes-body { margin-top: 8px; padding: 14px 18px; border-radius: 8px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle); font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
    .claude-notes-body code { background: rgba(201,169,97,0.15); padding: 1px 5px; border-radius: 3px; font-size: 12px; color: var(--gold); }
    .claude-notes-body .cn-row { display: flex; gap: 8px; margin-bottom: 4px; }
    .claude-notes-body .cn-label { color: var(--text-muted); min-width: 100px; flex-shrink: 0; }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Loading √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    .loading { min-height: 100vh; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 18px; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(201,169,97,0.3); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Responsive √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
    @media (max-width: 600px) {
      body { padding: 12px; }
      .header h1 { font-size: 20px; letter-spacing: 0.04em; }
      .day-tab-label { font-size: 9px; }
      .day-tab-num { font-size: 14px; width: 24px; height: 24px; line-height: 24px; }
      .event-time { min-width: 56px; font-size: 11px; }
    }
  </style>
</head>
<body>

<div id="app">
  <div class="loading"><div class="spinner"></div> Loading dashboard‚Ä¶</div>
</div>

<script>
// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ CONFIG √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
const API_BASE = "https://dashboardapi-production.up.railway.app";
const STORAGE_KEY = "les-dashboard-completed-v3";
const KEY_STORAGE = "les-dashboard-api-key";

function getApiKey() { return localStorage.getItem(KEY_STORAGE); }
function setApiKey(k) { localStorage.setItem(KEY_STORAGE, k); }


const DAY_ORDER = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const CAT_COLORS = { Writing: "#8B5CF6", Tech: "#0EA5E9", Ministry: "#C9A961", Content: "#EC4899", Personal: "#94A3B8" };
const SOURCE_COLORS = { les: "#3B82F6", craig: "#F97316", shared: "#8B5CF6" };
const URGENCY = {
  urgent:    { label: "üî¥ URGENT",    color: "#DC2626", order: 0 },
  upcoming:  { label: "üü° UPCOMING",  color: "#D97706", order: 1 },
  recurring: { label: "üîµ RECURRING", color: "#2563EB", order: 2 },
  active:    { label: "üü¢ ACTIVE",    color: "#059669", order: 3 },
  low:       { label: "‚ö™ LOW",       color: "#6B7280", order: 4 },
};

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ STATE √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
let groups = [];
let notices = [];
let calendarEvents = [];
let completed = {};
let expandedId = null;
let selectedDay = DAY_ORDER[new Date().getDay()];
let activeFilter = "all";
let lastFetched = null;
let error = null;
let claudeNotesOpen = false;
let editingNoticeId = null;
let calendarOpen = true;

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ HELPERS √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function daysUntilDeadline(task) {
  if (task.deadline) {
    const now = new Date(); now.setHours(0,0,0,0);
    const dl = new Date(task.deadline + "T00:00:00");
    return Math.ceil((dl - now) / 86400000);
  }
  if (task.recurring_deadline_day != null) {
    let d = task.recurring_deadline_day - new Date().getDay();
    if (d < 0) d += 7;
    return d;
  }
  return null;
}

function effectiveUrgency(task) {
  if (task.urgency === "urgent") return "urgent";
  const d = daysUntilDeadline(task);
  if (d !== null && d < 0) return "urgent";
  if (d !== null && d <= 2) return "upcoming";
  return task.urgency;
}

function loadCompleted() {
  try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : {}; } catch { return {}; }
}

function saveCompleted() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(completed)); } catch {}
}

async function fetchDashboard() {
  const key = getApiKey();
  if (!key) return promptForKey();
  const res = await fetch(`${API_BASE}/dashboard`, { headers: { "X-API-Key": key } });
  if (res.status === 401) { localStorage.removeItem(KEY_STORAGE); return promptForKey(); }
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

function promptForKey() {
  const app = document.getElementById("app");
  app.innerHTML = `
    <div style="max-width:400px;margin:100px auto;text-align:center;">
      <h1 style="color:#C9A961;font-size:24px;margin-bottom:16px;">Dashboard Setup</h1>
      <p class="ui" style="color:#A0AEC0;font-size:14px;margin-bottom:20px;">Enter your API key to connect.</p>
      <input id="key-input" type="password" placeholder="API key" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid rgba(201,169,97,0.4);background:rgba(255,255,255,0.08);color:#F5F1E8;font-size:14px;font-family:system-ui,sans-serif;outline:none;margin-bottom:12px;">
      <br><button id="key-submit" style="padding:10px 24px;border-radius:8px;border:none;background:#C9A961;color:#1B2845;font-size:14px;font-weight:600;cursor:pointer;font-family:system-ui,sans-serif;">Connect</button>
    </div>`;
  document.getElementById("key-submit").addEventListener("click", () => {
    const val = document.getElementById("key-input").value.trim();
    if (val) { setApiKey(val); loadDashboard(); }
  });
  document.getElementById("key-input").addEventListener("keydown", (e) => {
    if (e.key === "Enter") { const val = e.target.value.trim(); if (val) { setApiKey(val); loadDashboard(); } }
  });
  return null;
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ RENDER √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function render() {
  const app = document.getElementById("app");
  const now = new Date();
  const todayName = DAY_ORDER[now.getDay()];
  const sunday = new Date(now); sunday.setDate(now.getDate() - now.getDay());
  const weekDates = DAY_ORDER.map((_, i) => { const d = new Date(sunday); d.setDate(sunday.getDate() + i); return d; });
  const todayStr = now.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" });

  const allTasks = groups.flatMap(g => g.tasks);
  const urgentCount = allTasks.filter(t => effectiveUrgency(t) === "urgent").length;
  const upcomingCount = allTasks.filter(t => effectiveUrgency(t) === "upcoming").length;
  const totalDone = Object.values(completed).reduce((s, p) => s + Object.values(p).filter(Boolean).length, 0);

  // Filter groups
  let filtered = groups;
  if (activeFilter === "urgent") {
    filtered = groups.map(g => ({ ...g, tasks: g.tasks.filter(t => { const e = effectiveUrgency(t); return e === "urgent" || e === "upcoming"; }) })).filter(g => g.tasks.length > 0);
  } else if (activeFilter !== "all") {
    filtered = groups.filter(g => g.id === activeFilter);
  }

  // Build calendar lookup by date string
  const calByDate = {};
  calendarEvents.forEach(evt => {
    if (!calByDate[evt.date]) calByDate[evt.date] = [];
    calByDate[evt.date].push(evt);
  });

  // Helper: parse time string to minutes since midnight for sorting
  function timeToMinutes(t) {
    if (!t) return -1; // no time = "all day" events, show at top
    const m = t.match(/(\d+):(\d+)\s*(AM|PM)/i);
    if (m) {
      let h = parseInt(m[1]);
      const min = parseInt(m[2]);
      const ap = m[3].toUpperCase();
      if (ap === "PM" && h !== 12) h += 12;
      if (ap === "AM" && h === 12) h = 0;
      return h * 60 + min;
    }
    if (/^AM$/i.test(t.trim())) return 1; // "AM" = early
    if (/^PM$/i.test(t.trim())) return 720; // "PM" = after noon
    return -1;
  }

  // Sort each day's events by time
  Object.values(calByDate).forEach(dayEvents => {
    dayEvents.sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
  });

  // Get events for selected day, filter out past events if viewing today
  const selectedDateStr = weekDates[DAY_ORDER.indexOf(selectedDay)].toISOString().slice(0, 10);
  let selectedEvents = calByDate[selectedDateStr] || [];
  if (selectedDay === todayName) {
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    selectedEvents = selectedEvents.filter(evt => {
      const evtMin = timeToMinutes(evt.time);
      if (evtMin < 0) return true; // all-day events always show
      const dur = evt.duration || 60; // default assume 1hr
      return (evtMin + dur) > nowMinutes;
    });
  }

  app.innerHTML = `
    <!-- Header -->
    <div class="header">
      <h1>LES BROWN ‚Äî PROJECT DASHBOARD</h1>
      <div class="header-line"></div>
      <p class="header-date ui">${todayStr}</p>
      ${error ? `<div class="error-banner ui">‚ö† ${error}</div>` : ""}
      <div class="badges ui">
        ${urgentCount > 0 ? `<div class="badge badge-urgent">${urgentCount} urgent</div>` : ""}
        ${upcomingCount > 0 ? `<div class="badge badge-upcoming">${upcomingCount} upcoming</div>` : ""}
        ${totalDone > 0 ? `<div class="badge badge-done">${totalDone} action${totalDone > 1 ? "s" : ""} completed ‚úî</div>` : ""}
      </div>
    </div>

    <!-- Calendar -->
    <div class="calendar ui">
      <div class="calendar-header${calendarOpen ? '' : ' collapsed'}" id="calendar-toggle">
        <h2>Weekly Rhythm <span class="cal-chevron${calendarOpen ? '' : ' closed'}">&#x25BE;</span></h2>
        <span>Week of ${weekDates[0].toLocaleDateString("en-US", { month: "short", day: "numeric" })}</span>
      </div>
      ${calendarOpen ? `<div class="day-tabs">
        ${DAY_ORDER.map((day, i) => {
          const isToday = day === todayName;
          const isSel = day === selectedDay;
          const has = (calByDate[weekDates[i].toISOString().slice(0, 10)] || []).length > 0;
          return `<button class="day-tab${isSel ? " selected" : ""}${isToday ? " today" : ""}" data-day="${day}">
            <div class="day-tab-label">${day.slice(0,3)}</div>
            <div class="day-tab-num">${weekDates[i].getDate()}</div>
            ${has ? '<div class="day-dot"></div>' : ""}
          </button>`;
        }).join("")}
      </div>
      <div class="day-events">
        <div class="day-title">
          <h3>${selectedDay}</h3>
          ${selectedDay === todayName ? '<span class="today-badge">Today</span>' : ""}
        </div>
        ${selectedEvents.length === 0 ? '<p class="no-events">No scheduled items ‚Äî open time for projects</p>' :
          selectedEvents.map(evt => {
            const cc = SOURCE_COLORS[evt.source] || CAT_COLORS[evt.category] || "#94A3B8";
            return `<div class="event-row">
              <div class="event-time">${evt.time}</div>
              <div class="event-bar" style="background:${cc}"></div>
              <div class="event-body">
                <div>
                  <span class="event-name">${evt.event}</span>
                  ${evt.location ? `<span class="event-tag event-tag-location">üìç ${evt.location}</span>` : ""}
                  ${evt.automated ? '<span class="event-tag event-tag-auto">‚ö° Auto</span>' : ""}
                </div>
                ${evt.detail ? `<p class="event-detail">${evt.detail}</p>` : ""}
                ${evt.duration ? `<span class="event-duration">${evt.duration >= 60 ? (evt.duration/60)+"h" : evt.duration+"m"}</span>` : ""}
              </div>
            </div>`;
          }).join("")
        }
      </div>
    </div>` : ''}
    </div>

    <!-- Filters -->
    <div class="filters ui">
      <button class="filter-btn${activeFilter === "all" ? " active" : ""}" data-filter="all">All Projects</button>
      <button class="filter-btn${activeFilter === "urgent" ? " active" : ""}" data-filter="urgent">üî¥ Needs Attention</button>
      ${groups.map(g => `<button class="filter-btn${activeFilter === g.id ? " active" : ""}" data-filter="${g.id}">${g.icon} ${g.name}</button>`).join("")}
    </div>

    <!-- Notice Board -->
    ${notices.length > 0 ? `
    <div class="notice-board ui">
      <div class="notice-board-header">
        <span style="font-size:18px">&#x1F4CC;</span>
        <h3>Notice Board</h3>
        <span class="count">(${notices.length})</span>
      </div>
      ${notices.map(n => {
        const date = n.created_at ? new Date(n.created_at).toLocaleDateString("en-US", { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" }) : "";
        const pClass = n.priority === "important" ? "priority-important" : n.priority === "normal" ? "priority-normal" : "";
        const isEditing = editingNoticeId === n.id;
        return `<div class="notice-item ${pClass}">
          <div class="notice-meta">
            <span class="notice-author">${n.author || "System"}</span>
            <span class="notice-priority-tag ${n.priority || "fyi"}">${n.priority || "fyi"}</span>
            <span class="notice-date">${date}</span>
          </div>
          ${isEditing ? `
            <div class="notice-edit-area">
              <textarea id="notice-edit-text">${n.message}</textarea>
              <div class="notice-edit-actions">
                <button class="notice-save-btn" data-notice-save="${n.id}">Save</button>
                <button class="notice-cancel-btn" data-notice-cancel>Cancel</button>
              </div>
            </div>
          ` : `
            <p class="notice-message">${n.message}</p>
            <div class="notice-actions">
              <button class="notice-btn" data-notice-edit="${n.id}">Edit</button>
              <button class="notice-btn delete" data-notice-delete="${n.id}">Delete</button>
            </div>
          `}
        </div>`;
      }).join("")}
    </div>` : ""}

    <!-- Groups -->
    <div class="groups">
      ${filtered.map(group => {
        const sorted = [...group.tasks].sort((a,b) => (URGENCY[effectiveUrgency(a)]?.order ?? 99) - (URGENCY[effectiveUrgency(b)]?.order ?? 99));
        return `<div class="group">
          <div class="group-header ui">
            <span class="icon">${group.icon}</span>
            <h3 style="color:${group.color}">${group.name}</h3>
            <span class="count">(${group.tasks.length})</span>
          </div>
          ${sorted.map(task => {
            const eff = effectiveUrgency(task);
            const urg = URGENCY[eff];
            const taskDone = completed[task.id] || {};
            const doneCount = Object.values(taskDone).filter(Boolean).length;
            const dl = daysUntilDeadline(task);
            const isOpen = expandedId === task.id || group.id === "today";
            const borderClass = eff === "urgent" ? " urgent-border" : eff === "upcoming" ? " upcoming-border" : "";

            return `<div class="task-card${isOpen ? " expanded" : ""}${borderClass}">
              <div class="task-header" data-task-toggle="${task.id}">
                <div class="task-dot" style="background:${group.color}"></div>
                <div class="task-info ui">
                  <div class="task-title-row">
                    <h4>${task.name}</h4>
                    ${doneCount > 0 ? `<span class="done-tag">${doneCount}/${task.next_actions.length} done</span>` : ""}
                    ${dl !== null && dl >= 0 && dl <= 7 ? `<span class="deadline-tag ${dl <= 1 ? "deadline-urgent" : "deadline-warn"}">${dl === 0 ? "Due today" : dl === 1 ? "Due tomorrow" : dl + " days left"}</span>` : ""}
                  </div>
                  <p class="task-status">${task.status}</p>
                </div>
                <span class="urgency-tag ui" style="background:${urg.color}22;color:${urg.color}">${urg.label}</span>
                <span class="chevron${isOpen ? " open" : ""}">‚ñæ</span>
              </div>
              ${isOpen ? `<div class="task-body ui">
                <div class="section-label">Next Actions</div>
                ${task.next_actions.map((action, i) => {
                  const isDone = taskDone[i] === true;
                  return `<div class="action-item${isDone ? " done" : ""}" data-action="${task.id}-${i}">
                    <span class="action-check${isDone ? " checked" : ""}">${isDone ? "‚úî" : ""}</span>
                    <span>${action}</span>
                  </div>`;
                }).join("")}
                ${task.links && task.links.length > 0 ? `
                  <div class="section-label">Links & Files</div>
                  <div class="links-row">
                    ${task.links.map(l => `<a class="link-btn" href="${l.url}" target="_blank" rel="noopener">üîó ${l.label}</a>`).join("")}
                  </div>` : ""}
                ${task.notes ? `<div class="notes-box"><div class="section-label" style="margin-top:0">Notes & Reminders</div><p>${task.notes}</p></div>` : ""}
                <p class="last-touched">Last touched: ${task.last_touched}</p>
              </div>` : ""}
            </div>`;
          }).join("")}
        </div>`;
      }).join("")}
    </div>


    <!-- Claude Notes -->
    <div class="claude-notes ui">
      <div class="claude-notes-toggle" id="claude-notes-toggle">
        <span class="claude-notes-icon">&#x1F916;</span>
        <span class="claude-notes-label">Claude Notes</span>
        <span class="claude-notes-chevron${claudeNotesOpen ? ' open' : ''}">&#x25BE;</span>
      </div>
      ${claudeNotesOpen ? `<div class="claude-notes-body">
        <div class="cn-row"><span class="cn-label">Shared files:</span><span><code>curl -s https://raw.githubusercontent.com/hlesbrown/dashboard/main/shared/FILENAME</code></span></div>
        <div class="cn-row"><span class="cn-label">Available:</span><span>CLAUDE_NOTES.md (handbook) &middot; DASHBOARD_API_INSTRUCTIONS.md (API ref)</span></div>
        <div class="cn-row"><span class="cn-label">API key:</span><span><code>X-API-Key: hlbdashboard</code></span></div>
        <div class="cn-row"><span class="cn-label">API base:</span><span><code>https://dashboardapi-production.up.railway.app</code></span></div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">All Claudes: fetch CLAUDE_NOTES.md at start of every session for full handbook.</div>
      </div>` : ''}
    </div>

    <!-- Footer -->
    <div class="footer ui">
      <p>${allTasks.length} tasks across ${groups.length} groups ¬∑ Data from Railway API ¬∑ üü° UPCOMING = deadline within 2 days</p>
      <div class="footer-actions">
        ${lastFetched ? `<span>Fetched ${lastFetched.toLocaleTimeString()}</span>` : ""}
        <button class="footer-btn" id="refresh-btn">‚Üª Refresh</button>
        ${totalDone > 0 ? '<button class="footer-btn muted" id="reset-btn">Reset completed</button>' : ""}
      </div>
    </div>
  `;

  // √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Bind Events √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
  document.querySelectorAll(".day-tab").forEach(btn => {
    btn.addEventListener("click", () => { selectedDay = btn.dataset.day; render(); });
  });

  const calToggle = document.getElementById("calendar-toggle");
  if (calToggle) calToggle.addEventListener("click", () => { calendarOpen = !calendarOpen; render(); });

  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => { activeFilter = btn.dataset.filter; render(); });
  });

  document.querySelectorAll("[data-task-toggle]").forEach(el => {
    el.addEventListener("click", () => {
      const id = parseInt(el.dataset.taskToggle);
      expandedId = expandedId === id ? null : id;
      render();
    });
  });

  document.querySelectorAll("[data-action]").forEach(el => {
    el.addEventListener("click", (e) => {
      e.stopPropagation();
      const [taskId, actionIdx] = el.dataset.action.split("-").map(Number);
      if (!completed[taskId]) completed[taskId] = {};
      completed[taskId][actionIdx] = !completed[taskId][actionIdx];
      saveCompleted();
      render();
    });
  });

  const refreshBtn = document.getElementById("refresh-btn");
  if (refreshBtn) refreshBtn.addEventListener("click", loadDashboard);

  const cnToggle = document.getElementById("claude-notes-toggle");
  if (cnToggle) cnToggle.addEventListener("click", () => { claudeNotesOpen = !claudeNotesOpen; render(); });

  // Notice board events
  document.querySelectorAll("[data-notice-edit]").forEach(btn => {
    btn.addEventListener("click", () => { editingNoticeId = parseInt(btn.dataset.noticeEdit); render(); });
  });

  document.querySelectorAll("[data-notice-cancel]").forEach(btn => {
    btn.addEventListener("click", () => { editingNoticeId = null; render(); });
  });

  document.querySelectorAll("[data-notice-save]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = parseInt(btn.dataset.noticeSave);
      const text = document.getElementById("notice-edit-text").value.trim();
      if (!text) return;
      try {
        await fetch(`${API_BASE}/notices/${id}`, {
          method: "PUT",
          headers: { "X-API-Key": getApiKey(), "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        editingNoticeId = null;
        await loadDashboard();
      } catch (e) { console.error("Failed to update notice:", e); }
    });
  });

  document.querySelectorAll("[data-notice-delete]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = parseInt(btn.dataset.noticeDelete);
      if (!confirm("Delete this notice? This cannot be undone.")) return;
      try {
        await fetch(`${API_BASE}/notices/${id}`, {
          method: "DELETE",
          headers: { "X-API-Key": getApiKey() }
        });
        await loadDashboard();
      } catch (e) { console.error("Failed to delete notice:", e); }
    });
  });

  const resetBtn = document.getElementById("reset-btn");
  if (resetBtn) resetBtn.addEventListener("click", () => {
    if (confirm("Reset all completed actions? This can't be undone.")) {
      completed = {};
      saveCompleted();
      render();
    }
  });
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ INIT √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
async function loadDashboard() {
  try {
    const data = await fetchDashboard();
    if (!data) return; // waiting for key input
    groups = data.groups || data;
    notices = data.notices || [];
    calendarEvents = data.calendar || [];
    lastFetched = new Date();
    error = null;
  } catch (e) {
    error = e.message;
    console.error("API fetch failed:", e);
  }
  render();
}

completed = loadCompleted();
loadDashboard();

// Auto-refresh when switching back to this tab
document.addEventListener("visibilitychange", () => {
  if (!document.hidden && getApiKey()) loadDashboard();
});

// Register service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(() => {});
}
</script>
</body>
</html>
